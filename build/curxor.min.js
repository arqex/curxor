/*
curxor v0.3.0
https://github.com/arqex/curxor
BSD-2-Clause: https://github.com/arqex/curxor/raw/master/LICENSE
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Curxor=t()}(this,function(){"use strict";var e=new Function("return this")(),t={isObject:function(e){return e&&e.constructor==Object},isArray:function(e){return e&&e.constructor==Array},isWrapper:function(e){return e&&e.__notify},createNonEnumerable:function(e,t){var r={};for(var n in e)r[n]={value:e[n]};return Object.create(t||{},r)},error:function(e){var t=new Error(e);if(console)return console.error(t);throw t},clone:function(e){if(this.isArray(e))return e.slice(0);if(this.isObject(e)){var t={};for(var r in e)t[r]=e[r];return t}return e},addNE:function(e,t,r){var n=t;"undefined"!=typeof r&&(n={},n[t]=r);for(var i in n)Object.defineProperty(e,i,{enumerable:!1,configurable:!0,writable:!0,value:n[i]})},nextTick:function(){function t(){for(;n=i.shift();)n();s=!1}function r(e){i.push(e),s||(s=!0,u())}var n,i=[],s=!1,o=function(){if(!e.postMessage)return!1;var t=!0,r=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=r,t}(),a="nexttick",u=function(){return o?function(){e.postMessage(a,"*")}:function(){setTimeout(function(){p()},0)}}(),p=function(){return o?function(r){r.source===e&&r.data===a&&(r.stopPropagation(),t())}:t}();return o&&e.addEventListener("message",p,!0),r.removeListener=function(){e.removeEventListener("message",p,!0)},r}()},r={on:function(e,t,r){var n=this._events[e]||[];return n.push({callback:t,once:r}),this._events[e]=n,this},once:function(e,t){this.on(e,t,!0)},off:function(e,t){if("undefined"==typeof e)this._events={};else if("undefined"==typeof t)this._events[e]=[];else{var r,n=this._events[e]||[];for(r=n.length-1;r>=0;r--)n[r]===t&&n.splice(r,1)}return this},trigger:function(e){var t,r,n=[].slice.call(arguments,1),i=this._events[e]||[],s=[];for(t=0;t<i.length;t++)r=i[t],r.callback?r.callback.apply(null,n):r.once=!0,r.once&&s.push(t);for(t=s.length-1;t>=0;t--)i.splice(s[t],1);return this}},n=t.createNonEnumerable(r),i={Hash:{remove:function(e){var r=[],n=e;t.isArray(e)||(n=[e]);for(var i=0,s=n.length;s>i;i++)this.hasOwnProperty(n[i])&&r.push(n[i]);return r.length?this.__notify("remove",this,r):this}},List:{push:function(e){return this.append([e])},append:function(e){return e&&e.length?this.__notify("splice",this,[this.length,0].concat(e)):this},pop:function(){return this.length?this.__notify("splice",this,[this.length-1,1]):this},unshift:function(e){return this.prepend([e])},prepend:function(e){return e&&e.length?this.__notify("splice",this,[0,0].concat(e)):this},shift:function(){return this.length?this.__notify("splice",this,[0,1]):this},splice:function(){return this.__notify("splice",this,arguments)}}},s=function(e,t){this.nodes={},this.notify=t,this.tree=this.prepare(e)};s.prototype=t.createNonEnumerable({reset:function(e,t){this.tree=this.prepare(t,[[]])},update:function(e,r,n){return this[e]?this[e](r,n):t.error("Unknown update type: "+e)},replace:function(e,t){{var r,n=this.nodes[e.__id];n.__paths}for(var i in t)r=n[i],n[i]=this.prepare(t[i]),this.isLeaf(r)||(this.unRelate(r,n),n[i].__listener=r.__listener);return this.updateNodePath(n),n.__wrapper},remove:function(e,t){var r,n,i=this.nodes[e.__id];for(r=0,n=t.length;n>r;r++)this.unRelate(i[t[r]],i),delete i[t[r]];return this.updateNodePath(i),i.__wrapper},splice:function(e,t){var r,n,i=this.nodes[e.__id],s=i.splice.apply(i,t);for(r=2,n=t.length;n>r;r++)t[r]=this.prepare(t[r]);for(r=0,n=s.length;n>r;r++)this.unRelate(s[r],i);return this.updateNodePath(i),i.__wrapper},unRelate:function(e,r){if(r&&e&&e.__parents){var n=e.__parents.indexOf(r);-1!=n&&e.__parents.splice(n,1),e.__parents.length||delete this.nodes[e.__wrapper.__id]}if(t.isObject(e))for(var i in e)this.unRelate(e[i],e);else if(t.isArray(e))for(var s=0;s<e.length;s++)this.unRelate(e[s],e)},updateNodePath:function(e){if(e){var r,n,s,o;if(t.isObject(e)){r={};for(var a in e)o=e[a],r[a]=o&&o.__wrapper||o;this.setMixins(r,i.Hash)}else{for(r=[],n=0,s=e.length;s>n;n++)o=e[n],r.push(o&&o.__wrapper||o);this.setMixins(r,i.List)}for(Object.freeze&&Object.freeze(r),delete this.nodes[e.__wrapper.__id],e.__wrapper=r,this.nodes[r.__id]=e,this.trigger(e,"update",r),n=0;n<e.__parents.length;n++)this.updateNodePath(e.__parents[n])}},isLeaf:function(e){return!e||!e.__wrapper},get:function(e,r){for(var n,i=this.tree,s=[i],o=0;o<e.length&&i;)i=i[e[o++]],s.push(i);if(i||t.error("Path non existent: "+e.join(".")),r)for(o=0;o<s.length;o++)n=s[o],delete this.nodes[n.__wrapper.__id],n.__wrapper=!1,n.__toUpdate=!0;return i},prepare:function(e){if(t.isWrapper(e)){var r=this.nodes[e.__id];if(r)return console.log("copy"),r}return this.wrap(e)},wrap:function(e){var r,n,s=t.isObject(e)?0:t.isArray(e)?1:2,o=t.isWrapper(e);if(2===s)return e;if(r=this.addNodeProperties(s?[]:{}),n=o?e:s?[]:{},s)for(var a=0,u=e.length;u>a;a++)this.wrapChild(r,e[a],a,n);else for(var p in e)this.wrapChild(r,e[p],p,n);return o||this.setMixins(n,s?i.List:i.Hash),Object.freeze&&Object.freeze(n),r.__wrapper=n,this.nodes[n.__id]=r,r},wrapChild:function(e,r,n,i){var s=this.prepare(r);e[n]=s,t.isWrapper(i)||(i[n]=s&&s.__wrapper?s.__wrapper:s),s&&s.__parents&&s.__parents.push(e)},setMixins:function(e,r){t.addNE(e,{__id:createId(),__notify:this.notify,set:function(e,t){var r=e;return"undefined"!=typeof t&&(r={},r[e]=t),this.__notify("replace",this,r)},getPaths:function(){return this.__notify("path",this)},getListener:function(){return this.__notify("listener",this)}}),t.addNE(e,r)},addNodeProperties:function(e){return t.addNE(e,{__listener:!1,__parents:[],__wrapper:!1,__toUpdate:!1,__toReturn:!1}),e},trigger:function(e,r,n){var i=e.__listener;i&&!i.ticking&&(i.ticking=!0,t.nextTick(function(){i.ticking=!1,i.trigger(r,n)}))},createListener:function(e){var t=this.nodes[e.__id],r=t.__listener;return r||(r=Object.create(n,{_events:{value:[],writable:!0}}),t.__listener=r),r}});var o=function(e){var r,n=this,i=!1,o=function(e,s,o){if(!r.nodes[s.__id])return t.error("Can't udpate. The node is not in the curxor.");if("path"==e)return r.getPaths(s);if("listener"==e)return r.createListener(s);var a=r.update(e,s,o);return i||(i=!0,t.nextTick(function(){i=!1,n.trigger("update",r)})),a};r=new s(e,o),t.addNE(this,{getData:function(){return r.tree.__wrapper},setData:function(e){o("reset",r.tree.__wrapper,e)}}),this.__wrapper=r.tree.__wrapper,this._events=[]};return o.prototype=t.createNonEnumerable({},n),o});