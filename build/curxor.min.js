/*
curxor v0.1.2
https://github.com/arqex/curxor
BSD-2-Clause: https://github.com/arqex/curxor/raw/master/LICENSE
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Curxor=t()}(this,function(){"use strict";var e=new Function("return this")(),t={isObject:function(e){return e&&e.constructor==Object},isArray:function(e){return e&&e.constructor==Array},isWrapper:function(e){return e&&e.__notify},createNonEnumerable:function(e,t){var n={};for(var r in e)n[r]={value:e[r]};return Object.create(t||{},n)},error:function(e){var t=new Error(e);if(console)return console.error(t);throw t},clone:function(e){if(this.isArray(e))return e.slice(0);if(this.isObject(e)){var t={};for(var n in e)t[n]=e[n];return t}return e},addNE:function(e,t,n){var r=t;"undefined"!=typeof n&&(r={},r[t]=n);for(var i in r)Object.defineProperty(e,i,{enumerable:!1,configurable:!0,writable:!0,value:r[i]})},nextTick:function(){function t(){for(;r=i.shift();)r();s=!1}function n(e){i.push(e),s||(s=!0,h())}var r,i=[],s=!1,o=function(){if(!e.postMessage)return!1;var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}(),a="nexttick",h=function(){return o?function(){e.postMessage(a,"*")}:function(){setTimeout(function(){c()},0)}}(),c=function(){return o?function(n){n.source===e&&n.data===a&&(n.stopPropagation(),t())}:t}();return o&&e.addEventListener("message",c,!0),n.removeListener=function(){e.removeEventListener("message",c,!0)},n}()},n={on:function(e,t,n){var r=this._events[e]||[];return r.push({callback:t,once:n}),this._events[e]=r,this},once:function(e,t){this.on(e,t,!0)},off:function(e,t){if("undefined"==typeof e)this._events={};else if("undefined"==typeof t)this._events[e]=[];else{var n,r=this._events[e]||[];for(n=r.length-1;n>=0;n--)r[n]===t&&r.splice(n,1)}return this},trigger:function(e){var t,n,r=[].slice.call(arguments,1),i=this._events[e]||[],s=[];for(t=0;t<i.length;t++)n=i[t],n.callback?n.callback.apply(null,r):n.once=!0,n.once&&s.push(t);for(t=s.length-1;t>=0;t--)i.splice(s[t],1);return this}},r=t.createNonEnumerable(n),i={Hash:{remove:function(e){var n=[],r=e;t.isArray(e)||(r=[e]);for(var i=0,s=r.length;s>i;i++)this.hasOwnProperty(r[i])&&n.push(r[i]);n.length&&this.__notify("remove",this,n)}},List:{push:function(e){this.append([e])},append:function(e){e&&e.length&&this.__notify("splice",this,[this.length,0].concat(e))},pop:function(){if(!this.length)return void 0;var e=this.length-1,t=this[e];return this.__notify("splice",this,[e,1]),t},unshift:function(e){this.prepend([e])},prepend:function(e){e&&e.length&&this.__notify("splice",this,[0,0].concat(e))},shift:function(){if(!this.length)return void 0;var e=this[0];return this.__notify("splice",this,[0,1]),e},splice:function(e,t){var n=this.slice(e,t);return this.__notify("splice",this,arguments),n}}},s=function(e){this.tree=this.prepare(e,[[]]),this.nodes={},this.noPathNodes={}};s.prototype=t.createNonEnumerable({reset:function(e,t){this.tree=this.prepare(t,[[]])},update:function(e,n,r){return this[e]?void this[e](n,r):t.error("Unknown update type: "+e)},replace:function(e,t){var n,r,i=this.nodes[e.__id],s=i.__paths;this.cleanPaths(s);for(var o in t)r=i[o],n=this.addToPaths(s,o),this.removeReferences(i[o],n,!0),i[o]=this.prepare(t[o],n),r&&(i[o].__listener=r.__listener)},remove:function(e,t){var n,r,i=this.nodes[e.__id],s=i.__paths;for(this.cleanPaths(s),n=0,r=t.length;r>n;n++)this.removeReferences(i[t[n]],this.addToPaths(s,t[n]),!0),delete i[t[n]]},splice:function(e,t){var n,r,i=this.nodes[e.__id],s=i.__paths;this.cleanPaths(s);var o=i.splice.apply(i,t);for(n=2,r=t.length;r>n;n++)t[n]=this.prepare(t[n],this.addToPaths(s,t[0]+n-2));for(n=0,r=o.length;r>n;n++)this.removeReferences(o[n],this.addToPaths(s,n));for(n=t[0]+t.length-2,r=i.length;r>n;n++)this.refreshReferences(i[n],s,this.addToPaths(s,n))},cleanPaths:function(e){for(var t=0,n=e.length;n>t;t++)this.cleanPath(e[t])},cleanPath:function(e){this.get(e,!0)},get:function(e,n){for(var r,i=this.tree,s=[i],o=0;o<e.length&&i;)i=i[e[o++]],s.push(i);if(i||t.error("Path non existent: "+e.join(".")),n)for(o=0;o<s.length;o++)r=s[o],delete this.nodes[r.__wrapper.__id],r.__wrapper=!1,r.__toUpdate=!0;return i},copy:function(e,n,r){var i;if(t.isObject(e)){i={};for(var s in e)i[s]=this.copy(e[s],n.concat(s),r)}else if(t.isArray(e)){i=[];for(var o=0,a=e.length;a>o;o++)i.push(this.copy(e[o],n.concat(o),r))}return r(e,n,i)},prepare:function(e,n){return t.isWrapper(e)?this.prepareWrapper(e,n):this.clone(e,n)},addNodeProperties:function(e,n,r){t.addNE(e,{__listener:!1,__paths:this.addToPaths(n,r),__wrapper:!1,__toUpdate:!1})},clone:function(e,t){var n=this;return this.copy(e,[],function(e,r,i){return i?(n.addNodeProperties(i,t,r),i):e})},prepareWrapper:function(e,t){var n=this,r=this.nodes[e.__id];if(r)return this.copy(r,[],function(e,r,i){i&&(e.__paths=e.__paths.concat(n.addToPaths(t,r)))}),r;r=this.get(t[0]),r&&this.removeReferences(r,t);var i=this.restoreWrapper(e,t,[]);if(r)for(var s in n.noPathNodes)delete n.noPathNodes[s],delete n.nodes[s];return i},restoreWrapper:function(e,n,r){if(!t.isWrapper(e))return e;var i=this.nodes[e.__id];if(i)return i.__paths=i.__paths.concat(this.addToPaths(n,r)),delete this.noPathNodes[i.__wrapper.__id],i;var s,o,a;if(t.isObject(e)){s={};for(o in e)s[o]=this.restoreWrapper(e[o],n,r.concat(o))}else for(s=[],o=0,a=e.length;a>o;o++)s.push(this.restoreWrapper(e[o],n,r.concat(o)));return this.addNodeProperties(s,n,r),s},addToPaths:function(e,t){var n,r,i=[];if(!e)throw new Error("Null");for(n=0,r=e.length;r>n;n++)i.push(e[n].concat(t));return i},isParentPath:function(e,t){var n=!0,r=0,i=e.length;if(t.length<i)return!1;for(;n&&i>r;)n=e[r]==t[r++];return n},updateNodePaths:function(e,t,n){var r,i,s,o,a,h=e.__paths;for(i=0,s=t.length;s>i;i++)for(a=t[i],n&&(r=n[i][a.length]),o=h.length-1;o>=0;o--)this.isParentPath(a,h[o])&&(n?h[o][a.length]=r:h.splice(o,1))},removeReferences:function(e,t,n){var r=this;this.copy(e,[],function(e,i,s){s&&(r.updateNodePaths(e,t),e.__paths.length||(n?delete r.nodes[e.__wrapper.__id]:r.noPathNodes[e.__wrapper.__id]=e))})},refreshReferences:function(e,t,n){for(var r=this,i=0;i<n.length;i++)n[i];this.copy(e,[],function(e,i,s){if(s){r.updateNodePaths(e,t,n);{e.__paths}}})},trigger:function(e,n,r){var i=e.__listener;i&&!i.ticking&&(i.ticking=!0,t.nextTick(function(){i.ticking=!1,i.trigger(n,r)}))},createListener:function(e){var t=this.nodes[e.__id],n=t.__listener;return n||(n=Object.create(r,{_events:{value:[],writable:!0}}),t.__listener=n),n},addWrapper:function(e,t){e.__wrapper;e.__wrapper=t,this.nodes[t.__id]=e,e.__toUpdate&&(e.__toUpdate=!1,this.trigger(e,"update",t))},getPaths:function(e){return this.nodes[e.__id].__paths.slice(0)}});var o=function(e){var n=this,r=1,o={},a=new s(e,o),h=!1,c=function(e,r,i){return a.nodes[r.__id]?"path"==e?a.getPaths(r):"listener"==e?a.createListener(r):(a.update(e,r,i),n.__wrapper=u(a.tree,[]),void(h||(h=!0,t.nextTick(function(){h=!1,n.trigger("update")})))):t.error("Can't udpate. The node is not in the curxor.")},f=function(e,n){t.addNE(e,{__id:p(),__notify:c,set:function(e){this.__notify("replace",this,e)},getPaths:function(){return this.__notify("path",this)},getListener:function(){return this.__notify("listener",this)}}),t.addNE(e,n)},u=function(e){var n,r,s,o;if(t.isObject(e)){n={};for(r in e)n[r]=u(e[r]);f(n,i.Hash)}else{if(!t.isArray(e))return e;for(n=[],s=0,o=e.length;o>s;s++)n[s]=u(e[s]);f(n,i.List)}return e.__wrapper?e.__wrapper:(a.addWrapper(e,n),Object.freeze&&Object.freeze(n),n)},p=function(){return"w"+r++};this.__wrapper=u(a.tree,[]),this._events=[]};return o.prototype=t.createNonEnumerable({getData:function(){return this.__wrapper},setData:function(e){this.__wrapper.__notify("reset",this.__wrapper,e)}},r),o});