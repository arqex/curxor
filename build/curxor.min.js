/*
curxor v0.1.0
https://github.com/arqex/curxor
BSD-2-Clause: https://github.com/arqex/curxor/raw/master/LICENSE
*/
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Curxor=t()}(this,function(){"use strict";var e=new Function("return this")(),t={isObject:function(e){return e&&e.constructor==Object},isArray:function(e){return e&&e.constructor==Array},isWrapper:function(e){return e&&e instanceof i},createNonEnumerable:function(e,t){var n={};for(var r in e)n[r]={value:e[r]};return Object.create(t||{},n)},nextTick:function(){function t(){for(;r=i.shift();)r();o=!1}function n(e){i.push(e),o||(o=!0,a())}var r,i=[],o=!1,s=function(){if(!e.postMessage)return!1;var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}(),c="nexttick",a=function(){return s?function(){e.postMessage(c,"*")}:function(){setTimeout(function(){f()},0)}}(),f=function(){return s?function(n){n.source===e&&n.data===c&&(n.stopPropagation(),t())}:t}();return s&&e.addEventListener("message",f,!0),n.removeListener=function(){e.removeEventListener("message",f,!0)},n}()},n={on:function(e,t,n){var r=this._events[e]||[];return r.push({callback:t,once:n}),this._events[e]=r,this},once:function(e,t){this.on(e,t,!0)},off:function(e,t){if("undefined"==typeof e)this._events={};else if("undefined"==typeof t)this._events[e]=[];else{var n,r=this._events[e]||[];for(n=r.length-1;n>=0;n--)r[n]===t&&r.splice(n,1)}return this},trigger:function(e){var t,n,r=[].slice.call(arguments,1),i=this._events[e]||[],o=[];for(t=0;t<i.length;t++)n=i[t],n.callback?n.callback.apply(null,r):n.once=!0,n.once&&o.push(t);for(t=o.length-1;t>=0;t--)i.splice(o[t],1);return this}},r=t.createNonEnumerable(n),i=function(e,t,n){this.__addNE("__id",e),this.__addNE("__val",t),this.__addNE("__notify",n)};i.prototype=t.createNonEnumerable({val:function(){return this.__val},set:function(e){this.__notify("replace",this,e)},remove:function(){this.__notify("remove",this)},toString:function(){return this.__val.toString()},valueOf:function(){return this.__val.valueOf()},getPath:function(){return this.__notify("path",this)},__addNE:function(e,t){Object.defineProperty(this,e,{value:t})}});var o=function(e,t,n){var r={};for(var o in t)this[o]=t[o],r[o]=t[o].val();this.__addNE("__children",t),i.call(this,e,r,n)};o.prototype=t.createNonEnumerable({add:function(e,n){if(t.isObject(e))return this.__notify("add",this,e);var r={};r[e]=n,this.__notify("add",this,r)},remove:function(e){var n=e;if(!n)return this.__notify("remove",this);t.isArray(n)||(n=[n]);for(var r=0,i=n.length;i>r;r++)this.hasOwnProperty(n[r])&&this.__notify("remove",this,key)}},i.prototype);var s=function(e,t,n){for(var r=[],o=0,s=t.length;s>o;o++)this[o]=t[o],r.push(t[o].val());this.__addNE("__children",t),i.call(this,e,r,n)};s.prototype=t.createNonEnumerable({push:function(e){this.__notify("append",this,[e])},append:function(e){this.__notify("append",this,e)},pop:function(){var e=this.__children.length;if(!e)return void 0;var t=this._children[e-1];return this.__notify("pop",this),t},unshift:function(e){this.__notify("prepend",this,[e])},prepend:function(e){this.__notify("prepend",this,e)},shift:function(){var e=this.__children.length;if(!e)return void 0;var t=this.__children[0];return this.__notify("shift",this),t},splice:function(e,t){var n=this.__children.slice(e,t);return this.__notify("splice",this,arguments),n},size:function(){return this.__children.length},forEach:function(){return this.__children.forEach(ckbk)},map:function(e){return this.__children.map(e)},filter:function(e){return this.__children.filter(e)},indexOf:function(e){return this.__children.indexOf(e)}},i.prototype);var c=function(e,t){this.tree=this.clone(e),this.els=t};c.prototype=t.createNonEnumerable({update:function(e,t,n){if(!this[e])throw new Error("Unknown update type: "+e);this[e](e,t,n),"update"==e},replace:function(e,t,n){var r=this.getParent(t,!0),i=t[t.length-1];this.removeReferences(r[i]),r[i]=this.clone(n)},add:function(e,t,n){var r=this.get(t,!0);for(var i in n)this.removeReferences(r[i]),r[i]=this.clone(n[i])},remove:function(e,n,r){var i,o,s;if(r)for(i=this.get(n,!0),o=0,s=r.length;s>o;o++)this.removeReferences(i[r[o]]),delete i[r[o]];else i=this.getParent(n,!0),o=n[n.length-1],t.isObject(i)?(this.removeReferences(i[o]),delete i[o]):t.isArray(i)&&(this.removeReferences(i[o]),i.splice(o,1))},splice:function(e,t,n){var r,i,o=this.get(t,!0);for(r=2,i=n.length;i>r;r++)n[r]=this.clone(n[r]);var s=o.splice.apply(o,n);for(r=0,i=s.length;i>r;r++)this.removeReferences(s[r])},append:function(e,t,n){for(var r=this.get(t,!0),i=0,o=n.length;o>i;i++)r.push(this.clone(n[i]))},prepend:function(e,t,n){for(var r=this.get(t,!0),i=0,o=n.length;o>i;i++)r.push(this.clone(n[i]))},get:function(e,t){for(var n=this.tree,r=[n],i=0;i<e.length&&n;)n=n[e[i++]],r.push(n);if(!n)throw new Error("Path non existent: "+e.join("."));if(t)for(i=0;i<r.length;i++)delete r[i].__wrapper;return n},getParent:function(e,t){return this.get(e.slice(0,e.length-1),t)},each:function(e,n){if(n(e),t.isObject(e))for(var r in e)n(e[r]);else if(t.isArray(e))for(var i=0,o=e.length;o>i;i++)n(e[i])},copy:function(e,n,r){var i;if(t.isObject(e)){i={};for(var o in e)i[o]=this.copy(e[o],n.concat(o),r)}else if(t.isArray(e)){i=[];for(var s=0,c=e.length;c>s;s++)i.push(this.copy(e[s],n.concat(s),r))}return r(e,n,i)},clone:function(e){return this.copy(e,[],function(e,t,n){return n||new Object(e)})},prepare:function(e,n){return t.isWrapper(e)?this.prepareWrapper(e,n):this.clone(e)},prepareWrapper:function(e,n){var r=this.els;return this.copy(e,n,function(e,n,i){var o,s,c,a=e.__children;if(a)if(t.isArray(a))for(o=[],s=0,c=a.length;c>s;s++)o.push(i[s]);else o=i;else o=new Object(e.val());return o.__wrapper=e,r[e.__id]=n,o})},cloneOk:function(e){var n;if(t.isObject(e)){n={};for(var r in e)n[r]=this.clone(e[r])}else if(t.isArray(e)){n=[];for(var i=0,o=e.length;o>i;i++)n.push(this.clone(e[i]))}else n=new Object(e);return n},removeReferences:function(e){var t=this.els;this.each(e,function(e){e&&e.__wrapper&&delete t[e.__wrapper.__id]})}});var a=function(e){var n,r=this,a=1,f={},h=new c(e,f),u=function(e,i,o){var s=f[i.__id];return"path"==e?s:(h.update(e,s,o),r.__wrapper=p(h.tree,[]),void(n||(n=!0,t.nextTick(function(){n=!1,r.trigger("update")}))))},p=function(e,n){if(e.__wrapper)return f[e.__wrapper.__id]=n,e.__wrapper;var r;return r=t.isObject(e)?_(e,n):t.isArray(e)?l(e,n):new i(v(),e.valueOf(),u),e.__wrapper=r,f[r.__id]=n,Object.freeze&&Object.freeze(r),r},_=function(e,n){var r,i,s={},c=v();for(var a in e)i=n.concat(a),r=t.isWrapper(e[a])?e[a]:p(e[a],i),s[a]=r;return new o(c,s,u)},l=function(e,n){for(var r,i,o=[],c=v(),a=0,f=e.length;f>a;a++)i=n.concat(a),r=t.isWrapper(e[a])?e[a]:p(e[a],i),o.push(r);return new s(c,o,u)},v=function(){return"w"+a++};this.__wrapper=p(h.tree,[]),this._events=[]};return a.prototype=t.createNonEnumerable({getData:function(){return this.__wrapper}},r),a});