/*
curxor v0.0.0
https://github.com/arqex/curxor
BSD-2-Clause: https://github.com/arqex/curxor/raw/master/LICENSE
*/
!function(t,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?module.exports=n():t.Curxor=n()}(this,function(){"use strict";var t=new Function("return this")(),n={isObject:function(t){return t&&t.constructor==Object},isArray:function(t){return t&&t.constructor==Array},isWrapper:function(t){return t&&t instanceof i},createNonEnumerable:function(t,n){var e={};for(var r in t)e[r]={value:t[r]};return Object.create(n||{},e)},nextTick:function(){function n(){for(;r=i.shift();)r();o=!1}function e(t){i.push(t),o||(o=!0,c())}var r,i=[],o=!1,s=function(){if(!t.postMessage)return!1;var n=!0,e=t.onmessage;return t.onmessage=function(){n=!1},t.postMessage("","*"),t.onmessage=e,n}(),a="nexttick",c=function(){return s?function(){t.postMessage(a,"*")}:function(){setTimeout(function(){u()},0)}}(),u=function(){return s?function(e){e.source===t&&e.data===a&&(e.stopPropagation(),n())}:n}();return s&&t.addEventListener("message",u,!0),e.removeListener=function(){t.removeEventListener("message",u,!0)},e}()},e={on:function(t,n,e){var r=this._events[t]||[];return r.push({callback:n,once:e}),this._events[t]=r,this},once:function(t,n){this.on(t,n,!0)},off:function(t,n){if("undefined"==typeof t)this._events={};else if("undefined"==typeof n)this._events[t]=[];else{var e,r=this._events[t]||[];for(e=r.length-1;e>=0;e--)r[e]===n&&r.splice(e,1)}return this},trigger:function(t){var n,e,r=[].slice.call(arguments,1),i=this._events[t]||[],o=[];for(n=0;n<i.length;n++)e=i[n],e.callback?e.callback.apply(null,r):e.once=!0,e.once&&o.push(n);for(n=o.length-1;n>=0;n--)i.splice(o[n],1);return this}},r=n.createNonEnumerable(e),i=function(t,n,e){this.__addNE("__id",t),this.__addNE("__val",n),this.__addNE("__notify",e)};i.prototype=n.createNonEnumerable({val:function(){return this.__val},set:function(t){this.__notify("replace",this,t)},toString:function(){return this.__val.toString()},valueOf:function(){return this.__val.valueOf()},getPath:function(){return this.__notify("path",this)},__addNE:function(t,n){Object.defineProperty(this,t,{value:n})}});var o=function(t,n,e){var r={};for(var o in n)this[o]=n[o],r[o]=n[o].val();this.__addNE("__children",n),i.call(this,t,r,e)};o.prototype=n.createNonEnumerable({add:function(t,e){if(n.isObject(t))return this.__notify("add",this,t);var r={};r[t]=e,this.__notify("add",this,r)},remove:function(t){var e=t;n.isArray(e)||(e=[e]);for(var r=0,i=e.length;i>r;r++)this.hasOwnProperty(e[r])&&this.__notify("remove",this,key)}},i.prototype);var s=function(t,n,e){for(var r=[],o=0,s=n.length;s>o;o++)this[o]=n[o],r.push(n[o].val());this.__addNE("__children",n),i.call(this,t,r,e)};s.prototype=n.createNonEnumerable({push:function(t){this.__notify("append",this,[t])},append:function(t){this.__notify("append",this,t)},pop:function(){var t=this.__children.length;if(!t)return void 0;var n=this._children[t-1];return this.__notify("pop",this),n},unshift:function(t){this.__notify("prepend",this,[t])},prepend:function(t){this.__notify("prepend",this,t)},shift:function(){var t=this.__children.length;if(!t)return void 0;var n=this.__children[0];return this.__notify("shift",this),n},splice:function(t,n){var e=this.__children.slice(t,n);return this.__notify("splice",this,arguments),e},count:function(){return this.__children.length},forEach:function(){return this.__children.forEach(ckbk)},map:function(t){return this.__children.map(t)},filter:function(t){return this.__children.filter(t)},indexOf:function(t){return this.__children.indexOf(t)}},i.prototype);var a=function(t){this.tree=this.clone(t)};a.prototype=n.createNonEnumerable({update:function(t,n,e){if(!this[t])throw new Error("Unknown update type: "+t);this[t](t,n,e),"update"==t},replace:function(t,n,e){var r=this.get(n.slice(0,n.length-1),!0);r[n[n.length-1]]=this.clone(e)},add:function(t,n,e){var r=this.get(n,!0);for(var i in e)r[i]=this.clone(e[i])},remove:function(t,n,e){for(var r=this.get(n,!0),i=0,o=e.length;o>i;i++)delete r[e[i]]},splice:function(t,n,e){var r=this.get(n,!0);r.splice.apply(r,e)},append:function(t,n,e){for(var r=this.get(n,!0),i=0,o=e.length;o>i;i++)r.push(e[i])},prepend:function(t,n,e){for(var r=this.get(n,!0),i=0,o=e.length;o>i;i++)r.push(e[i])},get:function(t,n){for(var e=this.tree,r=[e],i=0;i<t.length&&e;)e=e[t[i++]],r.push(e);if(!e)throw new Error("Path non existent: "+t.join("."));if(n)for(i=0;i<r.length;i++)delete r[i].__wrapper;return e},clone:function(t){var e;if(n.isObject(t)){e={};for(var r in t)e[r]=this.clone(t[r])}else if(n.isArray(t)){e=[];for(var i=0,o=t.length;o>i;i++)e.push(this.clone(t[i]))}else e=new Object(t);return e}});var c=function(t){var e,r=this,c=1,u={},f=new a(t),h=function(t,i,o){var s=u[i.__id];return"path"==t?s:(f.update(t,s,o),r.__wrapper=p(f.tree,[]),void(e||(e=!0,n.nextTick(function(){e=!1,r.trigger("update")}))))},p=function(t,e){if(t.__wrapper)return t.__wrapper;var r;return r=n.isObject(t)?_(t,e):n.isArray(t)?l(t,e):new i(d(),t.valueOf(),h),t.__wrapper=r,Object.freeze&&Object.freeze(r),r},_=function(t,e){var r,i,s={},a=d();for(var c in t)i=e.concat(c),r=n.isWrapper(t[c])?t[c]:p(t[c],i),s[c]=r,u[r.__id]=i;return new o(a,s,h)},l=function(t,e){for(var r,i,o=[],a=d(),c=0,f=t.length;f>c;c++)i=e.concat(c),r=n.isWrapper(t[c])?t[c]:p(t[c],i),o.push(r),u[r._id]=i;return new s(a,o,h)},d=function(){return"w"+c++};this.__wrapper=p(f.tree,[]),this._events=[]};return c.prototype=n.createNonEnumerable({getData:function(){return this.__wrapper}},r),c});